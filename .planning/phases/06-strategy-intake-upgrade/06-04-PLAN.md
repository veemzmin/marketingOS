---
phase: 06-strategy-intake-upgrade
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/strategy/intake-engine.test.ts
autonomous: true

must_haves:
  truths:
    - "Test file exists at src/lib/strategy/intake-engine.test.ts"
    - "Tests assert no experiment variant contains urgency CTA strings"
    - "Tests assert no experiment or asset name contains 'patient story' or 'client story'"
    - "Tests assert confidenceScore is within 0–100 range"
    - "Tests assert stakeholdersClarityLevel is one of: high, medium, low"
    - "Tests assert requiresVisibilityArchive and requiresApprovalWorkflow are correctly split"
    - "All tests pass (npm test or npx jest)"
  artifacts:
    - path: "src/lib/strategy/intake-engine.test.ts"
      provides: "Safety guardrails + behavioral tests"
      contains: "URGENCY_FORBIDDEN_STRINGS"
  key_links:
    - from: "EXPERIMENT_LIBRARY"
      to: "test assertions"
      via: "import"
      pattern: "EXPERIMENT_LIBRARY.*variantA.*variantB"
---

<objective>
Create src/lib/strategy/intake-engine.test.ts with safety guardrail tests (Item 7) and behavioral regression tests for all new fields (Items 1–5). These run in CI and catch forbidden content or logic regressions.

Purpose: Deterministic safety enforcement. If an experiment variant ever gets urgency language added, the test fails immediately.
Output: New test file covering guardrails + new field behaviors.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-strategy-intake-upgrade/06-01-SUMMARY.md
@src/lib/strategy/intake-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create engine test file with safety guardrails and behavioral tests (Item 7 + regression)</name>
  <files>src/lib/strategy/intake-engine.test.ts</files>
  <action>
Create a NEW file at src/lib/strategy/intake-engine.test.ts. This file did not exist before.

Check if the project uses Jest or Vitest. Look at package.json for "jest" or "vitest" in dependencies/devDependencies. Use whichever test runner is configured. If neither is configured, use Jest (it is more common with Next.js).

Check if a jest.config file or vitest.config file exists at the project root to understand the test setup. Use the same import style as any existing test files in the project (check src/**/*.test.ts if any exist).

If using Jest with ts-jest or babel-jest, the import style is:
```ts
import { ... } from "@/lib/strategy/intake-engine"
```
or with relative path:
```ts
import { ... } from "../../lib/strategy/intake-engine"
```
Use whichever path alias works in the test environment.

Write the following test file content (adapt import path if needed):

```ts
/**
 * intake-engine.test.ts
 *
 * Safety guardrails (Item 7) + behavioral regression tests for Phase 6 fields.
 * These tests are deterministic — no randomness, no external deps.
 */
import {
  analyzeIntake,
  EXPERIMENT_LIBRARY,
} from "@/lib/strategy/intake-engine"

// ─── Item 7: Safety Guardrails ────────────────────────────────────────────────

const URGENCY_FORBIDDEN_STRINGS = [
  "call now",
  "book now",
  "book assessment",
  "act now",
  "limited spots",
  "don't wait",
  "dont wait",
  "schedule now",
]

const PATIENT_STORY_FORBIDDEN = ["patient story", "client story"]

describe("Safety guardrails — EXPERIMENT_LIBRARY (Item 7)", () => {
  EXPERIMENT_LIBRARY.forEach((exp) => {
    const variantTexts = [
      exp.variantA.toLowerCase(),
      exp.variantB.toLowerCase(),
      exp.name.toLowerCase(),
      exp.hypothesis.toLowerCase(),
    ]

    test(`${exp.id}: no urgency CTA strings in variants`, () => {
      for (const text of variantTexts) {
        for (const forbidden of URGENCY_FORBIDDEN_STRINGS) {
          expect(text).not.toContain(forbidden)
        }
      }
    })

    test(`${exp.id}: no patient/client story content by default`, () => {
      for (const text of variantTexts) {
        for (const forbidden of PATIENT_STORY_FORBIDDEN) {
          expect(text).not.toContain(forbidden)
        }
      }
    })
  })
})

// ─── Item 5: stakeholdersClarityLevel ─────────────────────────────────────────

describe("stakeholdersClarityLevel (Item 5)", () => {
  test("returns 'low' when no audience terms and vague terms present", () => {
    const result = analyzeIntake({
      intakeText: "We want to reach everyone in the community for general awareness",
    })
    expect(result.stakeholdersClarityLevel).toBe("low")
  })

  test("returns 'low' when no audience terms at all", () => {
    const result = analyzeIntake({
      intakeText: "We are launching a new program for general awareness and outreach",
    })
    expect(result.stakeholdersClarityLevel).toBe("low")
  })

  test("returns 'medium' when exactly one specific audience term present", () => {
    const result = analyzeIntake({
      intakeText: "This campaign targets families of individuals seeking care",
    })
    expect(result.stakeholdersClarityLevel).toBe("medium")
  })

  test("returns 'high' when two or more specific audience terms present", () => {
    const result = analyzeIntake({
      intakeText: "Campaign for referring physicians and primary care providers",
    })
    expect(result.stakeholdersClarityLevel).toBe("high")
  })
})

// ─── Item 1: confidenceScore ──────────────────────────────────────────────────

describe("confidenceScore (Item 1)", () => {
  test("is within 0–100 range for all inputs", () => {
    const inputs = [
      "general awareness",
      "We are launching a new IOP program. Email drip for referring physicians and providers.",
      "Compliance reporting for annual board report. State approval required.",
      "",
    ]
    for (const intakeText of inputs) {
      const result = analyzeIntake({ intakeText })
      expect(result.confidenceScore).toBeGreaterThanOrEqual(0)
      expect(result.confidenceScore).toBeLessThanOrEqual(100)
    }
  })

  test("higher score for strong signals than for no signals", () => {
    const weak = analyzeIntake({ intakeText: "general awareness campaign" })
    const strong = analyzeIntake({
      intakeText: "launching new program with compliance and referral enablement for providers",
    })
    expect(strong.confidenceScore).toBeGreaterThan(weak.confidenceScore)
  })
})

// ─── Item 3: Split compliance flags ───────────────────────────────────────────

describe("requiresVisibilityArchive and requiresApprovalWorkflow (Item 3)", () => {
  test("requiresVisibilityArchive true when compliance signal present", () => {
    const result = analyzeIntake({
      intakeText: "We need to demonstrate compliance for our state licensing audit",
    })
    expect(result.requiresVisibilityArchive).toBe(true)
  })

  test("requiresVisibilityArchive true when compliance-visibility signal present", () => {
    const result = analyzeIntake({
      intakeText: "Annual report for board review showing demonstrate compliance",
    })
    expect(result.requiresVisibilityArchive).toBe(true)
  })

  test("requiresApprovalWorkflow false when only compliance signal (no explicit gate terms)", () => {
    const result = analyzeIntake({
      intakeText: "We follow HIPAA compliance and are state-licensed",
    })
    expect(result.requiresApprovalWorkflow).toBe(false)
  })

  test("requiresApprovalWorkflow true when explicit approval gate terms present", () => {
    const result = analyzeIntake({
      intakeText: "All content review required before publish; approval required from compliance officer",
    })
    expect(result.requiresApprovalWorkflow).toBe(true)
  })

  test("both flags can be true simultaneously", () => {
    const result = analyzeIntake({
      intakeText: "Demonstrate compliance for annual report. Approval required before any send.",
    })
    expect(result.requiresVisibilityArchive).toBe(true)
    expect(result.requiresApprovalWorkflow).toBe(true)
  })

  test("both flags false for general awareness campaign", () => {
    const result = analyzeIntake({
      intakeText: "Community awareness campaign about mental health support",
    })
    expect(result.requiresVisibilityArchive).toBe(false)
    expect(result.requiresApprovalWorkflow).toBe(false)
  })
})

// ─── Item 2: evidence map ─────────────────────────────────────────────────────

describe("evidence map (Item 2)", () => {
  test("evidence keys match detectedSignalKeys", () => {
    const result = analyzeIntake({
      intakeText: "Launching new program. Email drip for providers. Social media campaign.",
    })
    for (const key of result.detectedSignalKeys) {
      // evidence may be absent for signals with no matchedTerms, but should exist for pattern-based ones
      if (key !== "stakeholders-unclear") {
        expect(result.evidence).toHaveProperty(key)
        expect((result.evidence as Record<string, string[]>)[key].length).toBeGreaterThan(0)
      }
    }
  })

  test("evidence arrays contain the actual matched term strings", () => {
    const result = analyzeIntake({ intakeText: "launching a new program rollout" })
    expect(result.evidence["launch"]).toContain("launch")
  })
})

// ─── Item 4: stack ────────────────────────────────────────────────────────────

describe("campaign stack (Item 4)", () => {
  test("stack is non-empty for program-launch archetype", () => {
    const result = analyzeIntake({ intakeText: "We are launching a new program" })
    expect(result.primaryArchetype).toBe("program-launch")
    expect(result.stack.length).toBeGreaterThanOrEqual(3)
    expect(result.stack.length).toBeLessThanOrEqual(6)
  })

  test("stack is non-empty for referral-enablement archetype", () => {
    const result = analyzeIntake({
      intakeText: "Provider referral enablement for physicians and care managers",
    })
    expect(result.primaryArchetype).toBe("referral-enablement")
    expect(result.stack.length).toBeGreaterThanOrEqual(3)
  })

  test("stack is non-empty for trust-building archetype", () => {
    const result = analyzeIntake({ intakeText: "Community awareness and stigma reduction outreach" })
    expect(result.primaryArchetype).toBe("trust-building")
    expect(result.stack.length).toBeGreaterThanOrEqual(3)
  })

  test("stack is non-empty for compliance-visibility archetype", () => {
    const result = analyzeIntake({
      intakeText: "Demonstrate compliance for annual report and performance dashboard for board",
    })
    expect(result.primaryArchetype).toBe("compliance-visibility")
    expect(result.stack.length).toBeGreaterThanOrEqual(3)
  })
})
```

After writing the file, check if there is a Jest config or if tests run with `npm test`. Look at package.json scripts to determine the test command.
  </action>
  <verify>
Run the test command (npm test or npx jest src/lib/strategy/intake-engine.test.ts).
Expected: ALL tests pass (0 failures).
If the test runner is not configured, verify TypeScript at minimum: npx tsc --noEmit exits 0.
  </verify>
  <done>
All tests pass. Zero failures. Safety guardrail tests assert no urgency CTAs and no patient-story content in EXPERIMENT_LIBRARY. Behavioral tests cover all four new field types.
  </done>
</task>

</tasks>

<verification>
Run: npm test (or npx jest if npm test runs more tests)
Expected output: All test suites pass. The intake-engine.test.ts suite specifically shows:
- "Safety guardrails — EXPERIMENT_LIBRARY" suite: all EXP-01 through EXP-10 tests pass
- "stakeholdersClarityLevel" suite: 4 tests pass
- "confidenceScore" suite: 2 tests pass
- "requiresVisibilityArchive and requiresApprovalWorkflow" suite: 6 tests pass
- "evidence map" suite: 2 tests pass
- "campaign stack" suite: 4 tests pass

Total: ~30 individual test cases all green.
</verification>

<success_criteria>
- Test file exists at src/lib/strategy/intake-engine.test.ts
- All tests pass (0 failures, 0 errors)
- Safety guardrail tests would fail if urgency CTAs were added to any EXPERIMENT_LIBRARY variant
- TypeScript compiles clean (npx tsc --noEmit exits 0)
</success_criteria>

<output>
After completion, create `.planning/phases/06-strategy-intake-upgrade/06-04-SUMMARY.md`
</output>
