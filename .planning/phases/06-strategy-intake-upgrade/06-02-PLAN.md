---
phase: 06-strategy-intake-upgrade
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/actions/strategy.ts
autonomous: true

must_haves:
  truths:
    - "StrategyRecommendation type has confidenceScore, evidence, stakeholdersClarityLevel, stack, requiresVisibilityArchive"
    - "Channels are archetype-first; paid social only appears when text contains paid/ads keywords"
    - "Channel array has no near-duplicate entries"
    - "Risk logic triggers claims warning when any of: launch, compliance, referral-enablement, integration-of-care detected"
    - "Unused CADENCE_RULES import is removed if present"
    - "TypeScript compiles without error"
  artifacts:
    - path: "src/app/actions/strategy.ts"
      provides: "Updated StrategyRecommendation type"
      contains: "confidenceScore"
    - path: "src/app/actions/strategy.ts"
      provides: "Archetype-first channel logic"
      contains: "ARCHETYPE_DEFAULT_CHANNELS"
  key_links:
    - from: "toRecommendation()"
      to: "IntakeAnalysis"
      via: "engine output fields"
      pattern: "analysis\\.confidenceScore"
    - from: "StrategyRecommendation"
      to: "UI"
      via: "returned object"
      pattern: "requiresVisibilityArchive"
---

<objective>
Update src/app/actions/strategy.ts to: pass through all new engine fields (Items 1–5), apply archetype-first channel logic (Item 10), deduplicate channels and assets (Item 11), fix risk trigger logic (Item 9), and remove any unused imports (Item 8).

Purpose: The action mapper is the bridge between engine and UI. It must expose all new fields and fix channel/risk logic before the UI plan runs.
Output: Updated strategy.ts with new StrategyRecommendation fields and corrected channel/risk logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-strategy-intake-upgrade/06-01-SUMMARY.md
@src/app/actions/strategy.ts
@src/lib/strategy/intake-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update StrategyRecommendation type and remove unused imports (Items 1–5, 8)</name>
  <files>src/app/actions/strategy.ts</files>
  <action>
STEP A — Check imports at top of file. The file currently imports:
```ts
import { analyzeIntake, type IntakeAnalysis } from "@/lib/strategy/intake-engine"
```
If CADENCE_RULES is imported anywhere in this file, remove it. The current file does NOT import CADENCE_RULES — confirm by reading the file. If absent, no change needed here.

STEP B — Update the StrategyRecommendation type. Current type ends with:
```ts
  requiresApprovalWorkflow: boolean
  plannerPrompt: string
```
Replace with:
```ts
  requiresVisibilityArchive: boolean    // NEW — Item 3
  requiresApprovalWorkflow: boolean
  confidenceScore: number               // NEW — Item 1
  evidence: Partial<Record<string, string[]>>  // NEW — Item 2 (use string keys for UI simplicity)
  stakeholdersClarityLevel: "high" | "medium" | "low"  // NEW — Item 5
  stack: string[]                       // NEW — Item 4
  plannerPrompt: string
```

Do NOT change any other part of the type. Do NOT change the function signatures.
  </action>
  <verify>npx tsc --noEmit shows only errors related to toRecommendation() not yet returning new fields (expected at this step)</verify>
  <done>StrategyRecommendation type has all 5 new fields listed above.</done>
</task>

<task type="auto">
  <name>Task 2: Archetype-first channels, dedup, risk fix, and pass-through new fields (Items 9, 10, 11, 1–5)</name>
  <files>src/app/actions/strategy.ts</files>
  <action>
Make targeted edits inside toRecommendation(). MINIMAL DIFFS — keep all code that is not touched by these items.

CHANGE 1 — Replace channel derivation with archetype-first logic (Item 10).
Remove the entire current channels block (lines ~34–57 in the original). Replace with:

```ts
// Archetype-first channel defaults (Item 10)
const ARCHETYPE_DEFAULT_CHANNELS: Record<string, string[]> = {
  "program-launch": ["Email sequence", "Social organic"],
  "referral-enablement": ["Provider email drip", "LinkedIn organic"],
  "trust-building": ["Social organic", "Email (monthly)"],
  "compliance-visibility": ["Stakeholder email (milestone-triggered)", "Documentation archive"],
}

const channels: string[] = [
  ...(ARCHETYPE_DEFAULT_CHANNELS[analysis.primaryArchetype] ?? ["Social organic", "Email (monthly)"]),
]

// Add flyer channel if signal present (signal-adds)
if (signalSet.has("flyer") && !channels.some((c) => c.toLowerCase().startsWith("print"))) {
  channels.push("Print / one-pager distribution")
}

// Only add paid social if explicit budget/ads signal in text (Item 10 constraint)
// Note: paid signal detection happens in engine; check for paid-related terms via a local check
// The engine does not have a "paid" signal, so do a simple text check here.
// The action function does not receive raw text — paid social is excluded by default.
// If future intake includes paid signals, add "paid" to SIGNAL_PATTERNS in engine first.
// For now: do NOT add "Paid social" unless a "paid" signal key is added to engine.
```

IMPORTANT: The ARCHETYPE_DEFAULT_CHANNELS constant must be defined inside toRecommendation() or as a module-level const — NOT exported. Place it just before the channels array construction.

CHANGE 2 — Deduplicate channels and assets (Item 11).
After building the channels array, add:
```ts
// Dedup channels: normalize to lowercase prefix match (Item 11)
const deduplicatedChannels = channels.filter((ch, idx) => {
  const normalized = ch.toLowerCase().replace(/[.,;]$/, "")
  return !channels.slice(0, idx).some(
    (prev) => prev.toLowerCase().replace(/[.,;]$/, "").startsWith(normalized.slice(0, 12)) ||
               normalized.startsWith(prev.toLowerCase().replace(/[.,;]$/, "").slice(0, 12))
  )
})
```
Then use `deduplicatedChannels` instead of `channels` in the returned object.

Likewise for assets — after the existing asset-building block, add:
```ts
// Dedup assets: exact string dedup only (Item 11)
const deduplicatedAssets = [...new Set(assets)]
```
Use `deduplicatedAssets` in the returned object.

CHANGE 3 — Fix risk trigger logic (Item 9).
Locate the current risks block:
```ts
if (analysis.primaryArchetype === "program-launch" && !signalSet.has("compliance")) {
  risks.push("Confirm all program claims are qualified and do not imply clinical outcomes")
}
```
Replace with:
```ts
// Claims warning triggers on any healthcare-related signal (Item 9)
const CLAIMS_TRIGGER_SIGNALS = ["launch", "compliance", "referral-enablement", "integration-of-care"]
if (CLAIMS_TRIGGER_SIGNALS.some((s) => signalSet.has(s as any))) {
  risks.push("Confirm all program claims are qualified and do not imply clinical outcomes")
}
```
Keep the existing trust-building urgency risk unchanged:
```ts
if (signalSet.has("trust-building")) {
  risks.push("Avoid any framing that implies urgency or pressure to seek care")
}
```

CHANGE 4 — Pass through new engine fields in the return statement.
In the return object at the bottom of toRecommendation(), add the new fields. Current return ends with:
```ts
    requiresApprovalWorkflow: analysis.requiresApprovalWorkflow,
    plannerPrompt: analysis.plannerPrompt,
```
Replace/extend to:
```ts
    requiresVisibilityArchive: analysis.requiresVisibilityArchive,
    requiresApprovalWorkflow: analysis.requiresApprovalWorkflow,
    confidenceScore: analysis.confidenceScore,
    evidence: analysis.evidence,
    stakeholdersClarityLevel: analysis.stakeholdersClarityLevel,
    stack: analysis.stack,
    plannerPrompt: analysis.plannerPrompt,
```
Also update the channels and assets fields to use deduped versions:
```ts
    channels: deduplicatedChannels,
    assets: deduplicatedAssets,
```

EDGE CASES:
- program-launch only (no paid keyword): channels = ["Email sequence", "Social organic"] — no "Paid social"
- referral-enablement primary: channels = ["Provider email drip", "LinkedIn organic"] — no generic "Social organic"
- trust-building + flyer signal: channels = ["Social organic", "Email (monthly)", "Print / one-pager distribution"]
- compliance only + no launch/referral/integration: claims risk does NOT fire (compliance is in the trigger list — it DOES fire). Verify: CLAIMS_TRIGGER_SIGNALS includes "compliance", so yes it fires.
- All signals present: dedup must not produce "Email sequence" + "Email (monthly)" as duplicates IF primary is program-launch (only program-launch defaults apply; trust-building defaults don't add unless archetype matches)
  </action>
  <verify>
Run: npx tsc --noEmit
Expected: zero errors.

Manual checks:
1. toRecommendation returns an object that satisfies StrategyRecommendation type
2. For a program-launch analysis: channels includes "Email sequence" and "Social organic" but NOT "Paid social"
3. For a trust-building analysis: channels includes "Social organic" and "Email (monthly)"
4. For a compliance analysis (no launch): risks includes the claims warning
5. No channel array contains two entries that share the same 12-char normalized prefix
  </verify>
  <done>
All of the following are true:
- npx tsc --noEmit exits 0
- StrategyRecommendation passes through all 5 new engine fields
- Channels are archetype-first; no "Paid social" without paid signal
- Dedup applied to channels and assets
- Claims risk fires for launch, compliance, referral-enablement, integration-of-care
  </done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` — zero errors.

Spot check the return shape by adding a temporary console.log in the action and running:
```bash
node -e "
const { analyzeIntake } = require('./src/lib/strategy/intake-engine')
// (or use ts-node if available)
"
```
If ts-node not available, TypeScript compile success is sufficient verification at this stage.
</verification>

<success_criteria>
- npx tsc --noEmit exits 0
- StrategyRecommendation type has requiresVisibilityArchive, confidenceScore, evidence, stakeholdersClarityLevel, stack
- Channels are archetype-driven, not signal-first
- No near-duplicate channels in any output
- Claims risk fires on launch/compliance/referral-enablement/integration-of-care
- No unused imports remain
</success_criteria>

<output>
After completion, create `.planning/phases/06-strategy-intake-upgrade/06-02-SUMMARY.md`
</output>
