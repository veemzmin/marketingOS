---
phase: 02-governance-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/governance/scoring/weights.ts
  - src/lib/governance/scoring/calculator.ts
autonomous: true

must_haves:
  truths:
    - "System calculates 0-100 compliance score from violations"
    - "System applies weighted penalties by policy type"
    - "System provides reasoning breakdown for score calculation"
    - "Medical claims violations penalize more than stigma language violations"
  artifacts:
    - path: "src/lib/governance/scoring/weights.ts"
      provides: "Hardcoded penalty weights for each policy type"
      exports: ["POLICY_WEIGHTS"]
      contains: "medical-claims.*25|suicide-safety.*30"
    - path: "src/lib/governance/scoring/calculator.ts"
      provides: "Score calculation function"
      exports: ["calculateComplianceScore"]
      min_lines: 40
  key_links:
    - from: "src/lib/governance/scoring/calculator.ts"
      to: "src/lib/governance/types.ts"
      via: "import type { Violation, ComplianceScore }"
      pattern: "import.*ComplianceScore.*from.*types"
    - from: "src/lib/governance/scoring/calculator.ts"
      to: "src/lib/governance/scoring/weights.ts"
      via: "import { POLICY_WEIGHTS }"
      pattern: "import.*POLICY_WEIGHTS"
---

<objective>
Build the compliance scoring engine that translates policy violations into quantitative compliance scores (0-100) with clear reasoning. This enables approval workflows (pass/fail thresholds) and organizational compliance metrics.

Purpose: Provide objective, auditable scoring that stakeholders trust. Weighted penalties ensure high-risk violations (medical claims, suicide safety) impact scores more than lower-risk violations (formatting, stigma language).

Output: Scoring calculator ready to consume violation arrays from validators and produce compliance scores with reasoning.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-governance-engine/02-CONTEXT.md
@.planning/phases/02-governance-engine/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define penalty weights for policy types</name>
  <files>src/lib/governance/scoring/weights.ts</files>
  <action>
Create hardcoded penalty weight configuration based on research recommendations:

```typescript
export const POLICY_WEIGHTS = {
  'medical-claims': {
    penalty: 25,
    description: 'Unsupported medical claim',
    maxPenalty: 25, // Single violation counts once
  },
  'suicide-safety': {
    penalty: 30,
    description: 'Suicide discussion without crisis resources',
    maxPenalty: 30, // Highest penalty - safety critical
  },
  'treatment-qualification': {
    penalty: 20,
    description: 'Unqualified treatment advice',
    maxPenalty: 20,
  },
  'dsm5-terminology': {
    penalty: 15,
    description: 'Invalid DSM-5 terminology',
    maxPenalty: 15,
  },
  'consent': {
    penalty: 10,
    description: 'Missing patient testimonial consent',
    maxPenalty: 10,
  },
  'stigma-language': {
    penalty: 5,
    description: 'Stigmatizing language',
    maxPenalty: 30, // Each term = -5 points, cap at 6 terms (30 points)
  },
} as const

export type PolicyId = keyof typeof POLICY_WEIGHTS
```

Document rationale in comments:
- Medical claims (25pts): Unsupported treatment claims are high-risk (potential harm, regulatory issues)
- Suicide safety (30pts): HIGHEST penalty - failing to provide crisis resources when discussing suicide is dangerous
- Treatment qualification (20pts): Unqualified advice ("cures") misleads patients
- DSM-5 (15pts): Incorrect terminology undermines clinical credibility
- Consent (10pts): Legal/HIPAA requirement but lower immediate risk than medical claims
- Stigma (5pts/term, max 30pts): Important for brand but lower medical risk than claims

Use research-validated weights. Note: Stigma is additive (multiple terms stack), others count once per content.
  </action>
  <verify>
```bash
npx tsc --noEmit --project tsconfig.json
```
No type errors. POLICY_WEIGHTS exports with 6 policy types.
  </verify>
  <done>Penalty weights defined and documented with healthcare compliance rationale.</done>
</task>

<task type="auto">
  <name>Task 2: Implement compliance score calculator</name>
  <files>src/lib/governance/scoring/calculator.ts</files>
  <action>
Create scoring calculator implementing weighted penalty algorithm from research:

```typescript
import type { Violation, ComplianceScore } from '../types'
import { POLICY_WEIGHTS, PolicyId } from './weights'

export function calculateComplianceScore(violations: Violation[]): ComplianceScore {
  if (violations.length === 0) {
    // Perfect score - all policies passed
    return {
      score: 100,
      reasoning: ['No policy violations found'],
      passed: Object.keys(POLICY_WEIGHTS),
      violations: [],
    }
  }

  let totalPenalty = 0
  const reasoning: string[] = []
  const passed: string[] = []

  // Group violations by policy ID
  const byPolicy = new Map<string, Violation[]>()
  violations.forEach(v => {
    if (!byPolicy.has(v.policyId)) byPolicy.set(v.policyId, [])
    byPolicy.get(v.policyId)!.push(v)
  })

  // Calculate penalties for each violated policy
  byPolicy.forEach((violationSet, policyId) => {
    const weight = POLICY_WEIGHTS[policyId as PolicyId]
    if (!weight) {
      console.warn(`Unknown policy ID: ${policyId}`)
      return
    }

    const count = violationSet.length
    let penalty = 0

    if (policyId === 'stigma-language') {
      // Stigma terms are additive: each violation -5 points, max -30 (6 terms)
      penalty = Math.min(count * weight.penalty, weight.maxPenalty)
      reasoning.push(`${weight.description} (${count} term${count > 1 ? 's' : ''}): -${penalty} points`)
    } else {
      // Other policies: single violation counts once
      penalty = weight.penalty
      reasoning.push(`${weight.description}: -${penalty} points`)
    }

    totalPenalty += penalty
  })

  // Identify policies that passed (not in violation map)
  Object.keys(POLICY_WEIGHTS).forEach(policyId => {
    if (!byPolicy.has(policyId)) {
      passed.push(policyId)
    }
  })

  // Score = 100 - totalPenalty, clamped to [0, 100]
  const score = Math.max(0, Math.min(100, 100 - totalPenalty))

  return {
    score: Math.round(score),
    reasoning,
    passed,
    violations,
  }
}
```

Follow research pattern: Score = 100 minus sum of penalties. Special handling for stigma (additive up to cap). Include reasoning for transparency. Return rounded score for UI display.
  </action>
  <verify>
```bash
npx tsc --noEmit --project tsconfig.json
```
No type errors. Function signature matches ComplianceScore return type.

Manual test in Node:
```bash
node -e "
const {calculateComplianceScore} = require('./src/lib/governance/scoring/calculator.ts');
const mockViolations = [
  {policyId: 'stigma-language', severity: 'medium', text: 'addict', explanation: 'test', startIndex: 0, endIndex: 6},
  {policyId: 'medical-claims', severity: 'high', text: 'cure', explanation: 'test', startIndex: 10, endIndex: 14},
];
const result = calculateComplianceScore(mockViolations);
console.log('Score:', result.score, 'Expected: 70 (100 - 25 - 5)');
"
```
  </verify>
  <done>Compliance score calculator implemented with weighted penalties and clear reasoning output.</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no type errors in scoring module
2. Verify POLICY_WEIGHTS has 6 entries (medical-claims, suicide-safety, treatment-qualification, dsm5-terminology, consent, stigma-language)
3. Test calculateComplianceScore with mock violations:
   - Empty array returns score: 100
   - Single medical-claims violation returns score: 75 (100 - 25)
   - 6 stigma violations cap at -30 points (score: 70)
4. Verify returned ComplianceScore includes reasoning array with human-readable explanations
</verification>

<success_criteria>
- [ ] 2 files created in src/lib/governance/scoring
- [ ] POLICY_WEIGHTS defines penalties for all 6 policy types
- [ ] Suicide safety has highest penalty (30 points) as per research
- [ ] Stigma language uses additive penalty (5pts/term, max 30pts)
- [ ] calculateComplianceScore returns 0-100 score clamped correctly
- [ ] Score calculation includes reasoning breakdown for transparency
- [ ] TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-governance-engine/02-02-SUMMARY.md` using the summary template.
</output>
