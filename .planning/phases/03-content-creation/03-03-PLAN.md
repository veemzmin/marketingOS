---
phase: 03-content-creation
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/dashboard/content/create/page.tsx
  - src/app/dashboard/content/[contentId]/edit/page.tsx
  - src/app/dashboard/content/list/page.tsx
  - src/components/content/ContentEditor.tsx
  - src/components/content/GovernanceFeedback.tsx
  - src/components/content/SaveStatus.tsx
  - src/components/content/ContentList.tsx
autonomous: false

must_haves:
  truths:
    - "Creator can create new content draft with metadata"
    - "Creator sees real-time policy violations while typing"
    - "Draft auto-saves without user action"
    - "Creator can submit content for review"
    - "Creator can view all their content with current status"
  artifacts:
    - path: "src/app/dashboard/content/create/page.tsx"
      provides: "Content creation page"
      min_lines: 30
    - path: "src/app/dashboard/content/list/page.tsx"
      provides: "Content list dashboard"
      min_lines: 50
    - path: "src/components/content/ContentEditor.tsx"
      provides: "Content editor component with React Hook Form"
      min_lines: 100
    - path: "src/components/content/GovernanceFeedback.tsx"
      provides: "Real-time governance violation display"
      min_lines: 30
  key_links:
    - from: "ContentEditor"
      to: "saveDraftAction"
      via: "debounced useEffect calling server action"
      pattern: "saveDraftAction"
    - from: "ContentEditor"
      to: "validateGovernanceAction"
      via: "debounced validation on body change"
      pattern: "validateGovernanceAction"
    - from: "useForm"
      to: "contentFormSchema"
      via: "zodResolver"
      pattern: "zodResolver\\(contentFormSchema\\)"
---

<objective>
Build content creation UI with real-time governance feedback and auto-save.

Purpose: Enable creators to draft content with immediate policy violation feedback, auto-save for data protection, and submit for review workflow.

Output: Content editor with React Hook Form validation, real-time governance feedback, auto-save, content list dashboard with status filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-creation/03-RESEARCH.md
@src/lib/actions/content.ts
@src/lib/validators/content-schema.ts
@src/lib/governance/validators/composite.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build content editor with real-time validation and auto-save</name>
  <files>
    src/components/content/ContentEditor.tsx
    src/components/content/GovernanceFeedback.tsx
    src/components/content/SaveStatus.tsx
    src/app/dashboard/content/create/page.tsx
    src/app/dashboard/content/[contentId]/edit/page.tsx
  </files>
  <action>
Create content editor following research patterns (React Hook Form + Zod, debounced validation, optimistic auto-save):

**1. src/components/content/ContentEditor.tsx** - Main editor component:

Follow the complete example from research (lines 887-1066 of 03-RESEARCH.md). Key features:
- useForm with zodResolver(contentFormSchema), mode: 'onBlur', reValidateMode: 'onChange'
- Debounced governance validation (300ms) on body change using useEffect with cleanup
- Debounced auto-save (1000ms) on any field change using useOptimistic for save state
- Real-time violation display with GovernanceFeedback component
- SaveStatus indicator showing "Saving...", "Saved", "Error"
- Form fields: title (input), body (textarea with char counter), topic (select), audience (select), tone (select)
- Submit button (disabled if violations exist)
- Props: initialContent (for edit mode), onSubmitSuccess (callback after submit)
- **IMPORTANT:** Call validateGovernanceAction from src/lib/actions/content.ts for real-time validation

**2. src/components/content/GovernanceFeedback.tsx** - Violation display:

```typescript
'use client'

import type { Violation } from '@/lib/governance/validators/composite'

interface GovernanceFeedbackProps {
  violations: Violation[]
  loading: boolean
}

export function GovernanceFeedback({ violations, loading }: GovernanceFeedbackProps) {
  if (loading) {
    return (
      <div className="border border-blue-200 bg-blue-50 rounded p-4">
        <p className="text-blue-600">Checking compliance...</p>
      </div>
    )
  }

  if (violations.length === 0) {
    return (
      <div className="border border-green-200 bg-green-50 rounded p-4">
        <p className="text-green-700 font-medium">✓ No policy violations detected</p>
      </div>
    )
  }

  return (
    <div className="border border-yellow-200 bg-yellow-50 rounded p-4">
      <h3 className="font-semibold text-yellow-900 mb-2">
        {violations.length} Policy Violation{violations.length !== 1 ? 's' : ''}
      </h3>
      <ul className="space-y-3">
        {violations.map((v, idx) => (
          <li key={`${v.policyId}-${idx}`} className="text-sm">
            <div className="font-medium text-yellow-800">{v.policyId}</div>
            <div className="text-yellow-700">{v.explanation}</div>
            {v.suggestion && (
              <div className="text-yellow-600 italic mt-1">Suggestion: {v.suggestion}</div>
            )}
          </li>
        ))}
      </ul>
    </div>
  )
}
```

**3. src/components/content/SaveStatus.tsx** - Auto-save indicator:

```typescript
'use client'

interface SaveStatusProps {
  state: 'idle' | 'saving' | 'saved' | 'error'
}

export function SaveStatus({ state }: SaveStatusProps) {
  if (state === 'idle') return null

  const stateConfig = {
    saving: { text: 'Saving...', className: 'text-blue-600' },
    saved: { text: 'Saved', className: 'text-green-600' },
    error: { text: 'Save failed', className: 'text-red-600' },
  }

  const config = stateConfig[state]
  return <span className={`text-sm ${config.className}`}>{config.text}</span>
}
```

**4. src/app/dashboard/content/create/page.tsx** - Create page:

```typescript
import { ContentEditor } from '@/components/content/ContentEditor'
import { redirect } from 'next/navigation'

export default function CreateContentPage() {
  const handleSubmitSuccess = (contentId: string) => {
    redirect(`/dashboard/content/list`)
  }

  return (
    <div className="max-w-4xl mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">Create Content</h1>
      <ContentEditor onSubmitSuccess={handleSubmitSuccess} />
    </div>
  )
}
```

**5. src/app/dashboard/content/[contentId]/edit/page.tsx** - Edit page:

```typescript
import { ContentEditor } from '@/components/content/ContentEditor'
import { getContentAction } from '@/lib/actions/content'
import { redirect } from 'next/navigation'

export default async function EditContentPage({ params }: { params: { contentId: string } }) {
  const { success, content, error } = await getContentAction({ contentId: params.contentId })

  if (!success || !content) {
    redirect('/dashboard/content/list')
  }

  if (content.status !== 'DRAFT') {
    redirect(`/dashboard/content/list`)
  }

  const handleSubmitSuccess = () => {
    redirect(`/dashboard/content/list`)
  }

  return (
    <div className="max-w-4xl mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">Edit Content</h1>
      <ContentEditor initialContent={content} onSubmitSuccess={handleSubmitSuccess} />
    </div>
  )
}
```

**Implementation notes from research:**
- Use 300ms debounce for governance validation (advisory feedback)
- Use 1000ms debounce for auto-save (creates version record)
- Always cleanup timers in useEffect return function
- Replace violations array on each validation (don't append)
- Only create version if content changed (server action handles this)
- Show "Saved" state for 2 seconds, then back to idle
- **Call validateGovernanceAction** from src/lib/actions/content.ts (not validateContent directly)
  </action>
  <verify>
Files exist in src/components/content/ and src/app/dashboard/content/
TypeScript compiles: `npx tsc --noEmit`
Components export properly: `grep "export" src/components/content/*.tsx`
Pages use server components where appropriate: `grep "'use client'" src/app/dashboard/content/*/page.tsx` (create/edit pages should NOT have 'use client' at top level)
  </verify>
  <done>
Content editor shows real-time governance feedback with debounced validation.
Auto-save creates versions after 1 second of inactivity.
Form validation prevents invalid submissions.
Create and edit pages route to editor component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build content list dashboard with status filtering</name>
  <files>
    src/components/content/ContentList.tsx
    src/app/dashboard/content/list/page.tsx
  </files>
  <action>
Create content list dashboard showing all content with status badges and filtering:

**1. src/components/content/ContentList.tsx** - Content table component:

```typescript
'use client'

import Link from 'next/link'
import { useState } from 'react'
import type { ContentStatus } from '@/lib/content/types'

interface ContentListProps {
  initialContents: Array<{
    id: string
    title: string
    status: ContentStatus
    complianceScore: number | null
    updatedAt: Date
    createdBy: { name: string | null; email: string }
  }>
}

export function ContentList({ initialContents }: ContentListProps) {
  const [statusFilter, setStatusFilter] = useState<string>('all')

  const filteredContents = statusFilter === 'all'
    ? initialContents
    : initialContents.filter(c => c.status === statusFilter)

  const getStatusBadgeColor = (status: ContentStatus) => {
    const colors: Record<ContentStatus, string> = {
      DRAFT: 'bg-gray-200 text-gray-800',
      SUBMITTED: 'bg-blue-200 text-blue-800',
      IN_REVIEW: 'bg-yellow-200 text-yellow-800',
      APPROVED: 'bg-green-200 text-green-800',
      REJECTED: 'bg-red-200 text-red-800',
    }
    return colors[status]
  }

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <button
          onClick={() => setStatusFilter('all')}
          className={`px-4 py-2 rounded ${statusFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
        >
          All
        </button>
        {['DRAFT', 'SUBMITTED', 'IN_REVIEW', 'APPROVED', 'REJECTED'].map(status => (
          <button
            key={status}
            onClick={() => setStatusFilter(status)}
            className={`px-4 py-2 rounded ${statusFilter === status ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
          >
            {status.replace('_', ' ')}
          </button>
        ))}
      </div>

      <div className="overflow-x-auto">
        <table className="w-full border-collapse border border-gray-300">
          <thead className="bg-gray-100">
            <tr>
              <th className="border p-3 text-left">Title</th>
              <th className="border p-3 text-left">Status</th>
              <th className="border p-3 text-center">Compliance</th>
              <th className="border p-3 text-left">Last Modified</th>
              <th className="border p-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody>
            {filteredContents.length === 0 ? (
              <tr>
                <td colSpan={5} className="border p-4 text-center text-gray-500">
                  No content found
                </td>
              </tr>
            ) : (
              filteredContents.map(content => (
                <tr key={content.id} className="hover:bg-gray-50">
                  <td className="border p-3 font-medium">{content.title}</td>
                  <td className="border p-3">
                    <span className={`px-2 py-1 rounded text-sm font-medium ${getStatusBadgeColor(content.status)}`}>
                      {content.status.replace('_', ' ')}
                    </span>
                  </td>
                  <td className="border p-3 text-center">
                    {content.complianceScore !== null ? (
                      <span className={content.complianceScore >= 70 ? 'text-green-600' : 'text-yellow-600'}>
                        {content.complianceScore}/100
                      </span>
                    ) : (
                      '—'
                    )}
                  </td>
                  <td className="border p-3 text-sm text-gray-600">
                    {new Date(content.updatedAt).toLocaleDateString()}
                  </td>
                  <td className="border p-3">
                    <Link
                      href={content.status === 'DRAFT' ? `/dashboard/content/${content.id}/edit` : `/dashboard/content/list`}
                      className="text-blue-600 hover:underline"
                    >
                      {content.status === 'DRAFT' ? 'Edit' : 'View'}
                    </Link>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}
```

**2. src/app/dashboard/content/list/page.tsx** - List page (server component):

```typescript
import { ContentList } from '@/components/content/ContentList'
import { listContentAction } from '@/lib/actions/content'
import Link from 'next/link'

export default async function ContentListPage() {
  const { success, contents } = await listContentAction()

  return (
    <div className="max-w-7xl mx-auto py-8">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Content Dashboard</h1>
        <Link
          href="/dashboard/content/create"
          className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
        >
          Create Content
        </Link>
      </div>

      {success ? (
        <ContentList initialContents={contents} />
      ) : (
        <div className="text-red-600">Failed to load content</div>
      )}
    </div>
  )
}
```

**Features from research:**
- Status filtering (all, draft, submitted, in_review, approved, rejected)
- Color-coded status badges
- Compliance score with color (green >=70, yellow <70)
- Action links (Edit for DRAFT, View for others - view just redirects to list since view page not planned)
- Empty state handling
  </action>
  <verify>
Files exist: src/components/content/ContentList.tsx, src/app/dashboard/content/list/page.tsx
TypeScript compiles: `npx tsc --noEmit`
List page is server component (no 'use client' directive at top)
ContentList component is client component ('use client' at top)
  </verify>
  <done>
Content list displays all content with status, compliance score, last modified date.
Status filtering works (all, draft, submitted, in_review, approved, rejected).
Action links route to edit (drafts) or list (other statuses, since view page not planned).
Create button navigates to content creation page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete content creation workflow:
- Content editor with React Hook Form validation
- Real-time governance feedback (debounced 300ms)
- Auto-save with optimistic UI (debounced 1000ms)
- Content list dashboard with status filtering
- Create/edit routing
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`

2. Navigate to content list: `http://localhost:3000/dashboard/content/list`
   - Verify: Empty state shows "No content found"
   - Verify: "Create Content" button visible

3. Click "Create Content" → navigate to `/dashboard/content/create`
   - Verify: Form loads with title, body, topic, audience, tone fields
   - Verify: Character counter shows "0 / 50000 characters"

4. Test form validation:
   - Type 2 characters in title, blur field → error: "Title must be at least 5 characters"
   - Type valid title (5+ chars) → error clears
   - Type 30 characters in body, blur → error: "Content must be at least 50 characters"
   - Type 60+ characters in body → error clears

5. Test real-time governance validation:
   - Type body content with stigma term (e.g., "This helps addicts recover")
   - Wait 300ms → Governance feedback appears showing stigma violation
   - Fix content (e.g., "This helps people with substance use disorder recover")
   - Wait 300ms → Governance feedback shows "No policy violations detected"

6. Test auto-save:
   - Type content in body field
   - Wait 1 second → "Saving..." appears → changes to "Saved"
   - Refresh page → navigate back to list → content should appear as DRAFT

7. Test submit workflow:
   - Click "Submit for Review" on compliant content
   - Verify: Redirects to view page (or list page)
   - Return to list → status should be "SUBMITTED" (not "DRAFT")

8. Test status filtering:
   - Create 2-3 pieces of content with different statuses (draft, submitted)
   - Click "DRAFT" filter → only drafts shown
   - Click "SUBMITTED" filter → only submitted content shown
   - Click "All" → all content shown

9. Test edit vs view routing:
Expected results:
- Form validation works (immediate feedback on blur, re-validates on change)
- Real-time governance feedback appears after 300ms typing pause
- Auto-save indicator shows "Saving..." → "Saved" after 1 second pause
- Content persists in database (visible in list after refresh)
- Status transitions work (draft → submitted)
- Filtering works (draft/submitted/all)
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. Content editor uses React Hook Form with zodResolver for validation
2. Real-time governance validation debounced at 300ms
3. Auto-save debounced at 1000ms with optimistic UI state
4. GovernanceFeedback component displays violations with suggestions
5. Content list shows all content with status badges and filtering
6. Status-based routing (edit for drafts, list redirect for others)
7. All components follow research patterns (cleanup timers, replace violations, version deduplication)
</verification>

<success_criteria>
- Creator can create content draft with metadata (CONT-01 satisfied)
- Creator sees real-time policy feedback while editing (CONT-02 satisfied)
- Creator can save drafts (auto-save after 1s inactivity) (CONT-03 satisfied)
- Creator can submit content for review (CONT-04 satisfied)
- Creator can view all content with current status (CONT-05 satisfied)
- System stores content versions (immutable audit trail) (CONT-06 satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-creation/03-03-SUMMARY.md`
</output>
