---
phase: 01-foundation-and-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
  - .env.example
  - prisma/migrations/*
autonomous: true
user_setup:
  - service: postgresql
    why: "Primary database for multi-tenant data with RLS"
    env_vars:
      - name: DATABASE_URL
        source: "Local PostgreSQL (docker run -e POSTGRES_PASSWORD=... -p 5432:5432 postgres:14) or hosted provider (Neon, Supabase, Railway)"
    setup_steps:
      - task: "Create database named 'marketing_os'"
        command: "psql -U postgres -c 'CREATE DATABASE marketing_os;'"

must_haves:
  truths:
    - "Developer can run `npx prisma db push` and schema applies to PostgreSQL"
    - "PostgreSQL RLS policies prevent cross-tenant data access"
    - "Organizations, Users, and AuditLogs tables exist with proper relationships"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Multi-tenant schema with User, Organization, AuditLog models"
      contains: "model Organization"
    - path: "prisma/migrations/*"
      provides: "SQL migration files including RLS policy setup"
      min_lines: 50
  key_links:
    - from: "prisma/schema.prisma"
      to: "PostgreSQL database"
      via: "DATABASE_URL connection"
      pattern: "datasource.*postgresql"
---

<objective>
Create Prisma schema with multi-tenant models (Organization, User, Role) and PostgreSQL Row-Level Security policies for defense-in-depth tenant isolation.

Purpose: Establish the database foundation that enforces data isolation at the database level, preventing cross-tenant leaks.
Output: Prisma schema file, initial migration with RLS policies, database ready for auth implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md

# Research findings
- PostgreSQL 14+ with RLS for tenant isolation (defense-in-depth)
- Prisma 5.7+ for Client Extensions (audit middleware)
- Immutable audit logs with append-only RLS policy
- Multi-tenant via organizationId on all scoped tables
</context>

<tasks>

<task type="auto">
  <name>Install Prisma and initialize schema</name>
  <files>package.json, prisma/schema.prisma, .env.example</files>
  <action>
    1. Install Prisma: `npm install prisma @prisma/client`
    2. Initialize Prisma: `npx prisma init --datasource-provider postgresql`
    3. Update .env.example to include DATABASE_URL with example:
       ```
       DATABASE_URL="postgresql://user:password@localhost:5432/marketing_os?schema=public"
       ```
    4. Create .env file (copy from .env.example) for local development
    5. Verify prisma/schema.prisma created with PostgreSQL datasource
  </action>
  <verify>
    Run `npx prisma validate` - should pass without errors.
    Check that prisma/schema.prisma exists with datasource db provider = "postgresql"
  </verify>
  <done>
    Prisma installed and initialized with PostgreSQL datasource configured.
  </done>
</task>

<task type="auto">
  <name>Define multi-tenant schema models</name>
  <files>prisma/schema.prisma</files>
  <action>
    Create comprehensive schema with multi-tenant models and relationships:

    ```prisma
    generator client {
      provider = "prisma-client-js"
    }

    datasource db {
      provider = "postgresql"
      url      = env("DATABASE_URL")
    }

    // Organizations (tenants)
    model Organization {
      id        String   @id @default(cuid())
      slug      String   @unique
      name      String
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      members   UserOrganization[]
      auditLogs AuditLog[]

      @@map("organizations")
    }

    // Users (can belong to multiple organizations)
    model User {
      id            String    @id @default(cuid())
      email         String    @unique
      emailVerified DateTime?
      name          String?
      passwordHash  String

      // 2FA fields
      totpEnabled Boolean @default(false)
      totpSecret  String?

      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      organizations UserOrganization[]
      verificationTokens EmailVerificationToken[]
      totpSetups TotpSetup[]

      @@map("users")
    }

    // Join table for User-Organization with role
    model UserOrganization {
      id             String @id @default(cuid())
      userId         String
      organizationId String
      role           Role   @default(CREATOR)

      user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
      organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

      createdAt DateTime @default(now())

      @@unique([userId, organizationId])
      @@index([organizationId])
      @@map("user_organizations")
    }

    // Roles enum
    enum Role {
      ADMIN
      REVIEWER
      CREATOR
      VIEWER
    }

    // Email verification tokens
    model EmailVerificationToken {
      id        String   @id @default(cuid())
      userId    String
      token     String   @unique
      expiresAt DateTime

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      createdAt DateTime @default(now())

      @@index([token])
      @@map("email_verification_tokens")
    }

    // TOTP setup (temporary, expires in 10 min)
    model TotpSetup {
      id        String   @id @default(cuid())
      userId    String
      secret    String
      expiresAt DateTime

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      createdAt DateTime @default(now())

      @@index([userId])
      @@map("totp_setups")
    }

    // Audit logs (immutable, append-only via RLS)
    model AuditLog {
      id             String   @id @default(cuid())
      organizationId String

      userId    String
      userEmail String

      action     String // create, update, delete, login, logout, role_grant, role_revoke
      resource   String // model name or resource type
      resourceId String

      changes  Json? // before/after for updates
      metadata Json? // additional context

      createdAt DateTime @default(now()) @db.Timestamp(3)

      organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

      @@index([organizationId])
      @@index([userId])
      @@index([createdAt])
      @@map("audit_logs")
    }
    ```

    Notes:
    - User can belong to multiple organizations (UserOrganization join table)
    - Role is per-organization (same user can be Admin in one org, Creator in another)
    - AuditLog has organizationId for RLS filtering
    - EmailVerificationToken and TotpSetup have expiry for cleanup
  </action>
  <verify>
    Run `npx prisma validate` - should pass.
    Run `npx prisma format` - should format schema correctly.
  </verify>
  <done>
    Prisma schema includes Organization, User, UserOrganization, Role enum, EmailVerificationToken, TotpSetup, AuditLog models with proper relationships.
  </done>
</task>

<task type="auto">
  <name>Create migration with RLS policies</name>
  <files>prisma/migrations/*, .env</files>
  <action>
    1. Generate initial migration: `npx prisma migrate dev --name init_multi_tenant_schema`
    2. Create custom migration file for RLS policies:
       `prisma/migrations/[timestamp]_add_rls_policies/migration.sql`

    Add RLS policy SQL (append to generated migration or create separate migration):

    ```sql
    -- Enable RLS on tenant-scoped tables
    ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
    ALTER TABLE user_organizations ENABLE ROW LEVEL SECURITY;
    ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

    -- Organization isolation policy
    CREATE POLICY tenant_isolation_organizations ON organizations
      USING (id::text = current_setting('app.current_tenant_id', true));

    -- UserOrganization isolation policy
    CREATE POLICY tenant_isolation_user_orgs ON user_organizations
      USING (organization_id = current_setting('app.current_tenant_id', true));

    -- AuditLog isolation policy
    CREATE POLICY tenant_isolation_audit_logs ON audit_logs
      USING (organization_id = current_setting('app.current_tenant_id', true));

    -- AuditLog append-only enforcement (no updates or deletes)
    CREATE POLICY audit_immutable_update ON audit_logs
      FOR UPDATE
      USING (false);

    CREATE POLICY audit_immutable_delete ON audit_logs
      FOR DELETE
      USING (false);

    -- Users table does NOT have RLS (users can belong to multiple orgs)
    -- Access controlled via UserOrganization join table

    -- Create app_user role (not superuser, respects RLS)
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'app_user') THEN
        CREATE ROLE app_user WITH LOGIN PASSWORD 'change_in_production';
        GRANT CONNECT ON DATABASE marketing_os TO app_user;
        GRANT USAGE ON SCHEMA public TO app_user;
        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
        GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
      END IF;
    END
    $$;
    ```

    3. Run migration: `npx prisma migrate deploy` (or already applied via migrate dev)
    4. Generate Prisma Client: `npx prisma generate`

    IMPORTANT: In production, update DATABASE_URL to use app_user role (not postgres superuser) to enforce RLS.
  </action>
  <verify>
    Run `npx prisma migrate status` - should show all migrations applied.
    Connect to database: `psql $DATABASE_URL -c "\d+ organizations"` - should show RLS enabled.
    Query RLS policies: `SELECT tablename, policyname FROM pg_policies WHERE tablename IN ('organizations', 'audit_logs');` - should list policies.
  </verify>
  <done>
    Database migration applied with multi-tenant schema, RLS enabled on organizations/user_organizations/audit_logs, append-only policy on audit_logs, app_user role created.
  </done>
</task>

</tasks>

<verification>
1. Prisma schema validates successfully
2. Database migration applied (check via `npx prisma migrate status`)
3. RLS enabled on organizations, user_organizations, audit_logs tables
4. Append-only policy prevents UPDATE/DELETE on audit_logs
5. Prisma Client generated and importable
</verification>

<success_criteria>
- Prisma schema defines multi-tenant models with relationships
- PostgreSQL database has tables created via migration
- RLS policies active on tenant-scoped tables
- Audit logs protected by append-only policy
- Database ready for auth implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md`
</output>
