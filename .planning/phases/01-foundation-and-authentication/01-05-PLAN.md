---
phase: 01-foundation-and-authentication
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - package.json
  - src/app/settings/security/page.tsx
  - src/app/api/auth/totp/setup/route.ts
  - src/app/api/auth/totp/verify/route.ts
  - src/app/api/auth/totp/validate/route.ts
  - src/app/actions/auth.ts
  - src/app/auth/verify-2fa/page.tsx
  - auth.ts
autonomous: true

must_haves:
  truths:
    - "User can enable 2FA by scanning QR code with authenticator app (AUTH-02)"
    - "User can verify TOTP code during setup to confirm configuration"
    - "User with 2FA enabled must provide TOTP code after password login"
    - "Invalid TOTP codes are rejected"
  artifacts:
    - path: "src/app/api/auth/totp/setup/route.ts"
      provides: "TOTP secret generation and QR code creation"
      exports: ["POST"]
    - path: "src/app/auth/verify-2fa/page.tsx"
      provides: "2FA code entry page shown after successful password login"
      min_lines: 50
  key_links:
    - from: "src/app/settings/security/page.tsx"
      to: "/api/auth/totp/setup"
      via: "fetch request to generate QR code"
      pattern: "fetch.*totp/setup"
    - from: "src/app/auth/verify-2fa/page.tsx"
      to: "/api/auth/totp/validate"
      via: "form submission with TOTP code"
      pattern: "totp/validate"
    - from: "auth.ts (authorize callback)"
      to: "user.totpEnabled"
      via: "check if 2FA required"
      pattern: "totpEnabled"
---

<objective>
Implement TOTP-based 2FA using speakeasy and qrcode, allowing users to enable 2FA via authenticator apps (Google Authenticator, Authy, 1Password).

Purpose: Add second factor authentication for healthcare compliance, reducing account takeover risk.
Output: Working 2FA enrollment flow with QR code generation, TOTP verification during login, and security settings page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md

# Research guidance
- speakeasy for TOTP generation/verification
- qrcode for QR code display
- TotpSetup table for temporary secrets (10 min expiry)
- User.totpSecret stores verified secret
- 2-window tolerance (±60 seconds for clock skew)
</context>

<tasks>

<task type="auto">
  <name>Install TOTP dependencies and create setup endpoint</name>
  <files>package.json, src/app/api/auth/totp/setup/route.ts</files>
  <action>
    1. Install dependencies:
       ```bash
       npm install speakeasy qrcode
       npm install -D @types/speakeasy @types/qrcode
       ```

    2. Create src/app/api/auth/totp/setup/route.ts:
       ```ts
       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import speakeasy from "speakeasy"
       import QRCode from "qrcode"
       import { NextResponse } from "next/server"

       export async function POST() {
         const session = await auth()
         if (!session?.user?.id) {
           return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
         }

         // Check if user already has 2FA enabled
         const user = await prisma.user.findUnique({
           where: { id: session.user.id },
           select: { totpEnabled: true },
         })

         if (user?.totpEnabled) {
           return NextResponse.json(
             { error: "2FA already enabled" },
             { status: 400 }
           )
         }

         // Generate TOTP secret
         const secret = speakeasy.generateSecret({
           name: `Marketing OS (${session.user.email})`,
           issuer: "Marketing OS",
           length: 32,
         })

         // Generate QR code
         const qrCodeUrl = await QRCode.toDataURL(secret.otpauth_url!)

         // Store secret temporarily (expires in 10 minutes)
         const expiresAt = new Date(Date.now() + 10 * 60 * 1000)

         // Delete any existing setup for this user
         await prisma.totpSetup.deleteMany({
           where: { userId: session.user.id },
         })

         await prisma.totpSetup.create({
           data: {
             userId: session.user.id,
             secret: secret.base32,
             expiresAt,
           },
         })

         return NextResponse.json({
           qrCode: qrCodeUrl,
           secret: secret.base32, // For manual entry if QR doesn't work
         })
       }
       ```

    Why 10 min expiry: Users scan QR and verify immediately; longer expiry increases attack window.
  </action>
  <verify>
    Test endpoint with authenticated session - should return QR code data URL and base32 secret.
  </verify>
  <done>
    TOTP setup endpoint generates secret, creates QR code, stores temporary TotpSetup record with 10min expiry.
  </done>
</task>

<task type="auto">
  <name>Create TOTP verification endpoints</name>
  <files>src/app/api/auth/totp/verify/route.ts, src/app/api/auth/totp/validate/route.ts</files>
  <action>
    1. Create src/app/api/auth/totp/verify/route.ts (verifies code during setup):
       ```ts
       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import speakeasy from "speakeasy"
       import { NextResponse } from "next/server"

       export async function POST(request: Request) {
         const session = await auth()
         if (!session?.user?.id) {
           return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
         }

         const { code } = await request.json()

         if (!code || typeof code !== "string") {
           return NextResponse.json({ error: "Code required" }, { status: 400 })
         }

         // Fetch temporary setup
         const setup = await prisma.totpSetup.findFirst({
           where: {
             userId: session.user.id,
             expiresAt: { gt: new Date() },
           },
         })

         if (!setup) {
           return NextResponse.json(
             { error: "Setup expired. Please start over." },
             { status: 400 }
           )
         }

         // Verify TOTP code (allow ±60 seconds for clock skew)
         const verified = speakeasy.totp.verify({
           secret: setup.secret,
           encoding: "base32",
           token: code,
           window: 2, // ±60 seconds
         })

         if (!verified) {
           return NextResponse.json(
             { error: "Invalid code. Please try again." },
             { status: 400 }
           )
         }

         // Enable 2FA for user
         await prisma.user.update({
           where: { id: session.user.id },
           data: {
             totpEnabled: true,
             totpSecret: setup.secret,
           },
         })

         // Delete temporary setup
         await prisma.totpSetup.delete({ where: { id: setup.id } })

         return NextResponse.json({ success: true })
       }
       ```

    2. Create src/app/api/auth/totp/validate/route.ts (validates during login):
       ```ts
       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import speakeasy from "speakeasy"
       import { NextResponse } from "next/server"

       export async function POST(request: Request) {
         const { userId, code } = await request.json()

         if (!userId || !code) {
           return NextResponse.json(
             { error: "User ID and code required" },
             { status: 400 }
           )
         }

         // Fetch user's TOTP secret
         const user = await prisma.user.findUnique({
           where: { id: userId },
           select: { totpSecret: true, totpEnabled: true },
         })

         if (!user?.totpEnabled || !user.totpSecret) {
           return NextResponse.json(
             { error: "2FA not enabled for user" },
             { status: 400 }
           )
         }

         // Verify TOTP code
         const verified = speakeasy.totp.verify({
           secret: user.totpSecret,
           encoding: "base32",
           token: code,
           window: 2,
         })

         if (!verified) {
           return NextResponse.json(
             { error: "Invalid code" },
             { status: 400 }
           )
         }

         return NextResponse.json({ success: true })
       }
       ```
  </action>
  <verify>
    Test verification flow:
    1. Call /totp/setup to get secret
    2. Use speakeasy.totp.generate() with same secret to generate code
    3. Call /totp/verify with generated code - should succeed
  </verify>
  <done>
    TOTP verification endpoint validates codes during setup, validate endpoint checks codes during login.
  </done>
</task>

<task type="auto">
  <name>Build 2FA UI and integrate with login flow</name>
  <files>src/app/settings/security/page.tsx, src/app/auth/verify-2fa/page.tsx, src/app/actions/auth.ts, auth.ts</files>
  <action>
    1. Create src/app/settings/security/page.tsx (2FA setup UI):
       ```tsx
       "use client"

       import { useState } from "react"
       import { auth } from "@/auth"

       export default function SecuritySettingsPage() {
         const [qrCode, setQrCode] = useState<string | null>(null)
         const [secret, setSecret] = useState<string | null>(null)
         const [code, setCode] = useState("")
         const [error, setError] = useState<string | null>(null)
         const [success, setSuccess] = useState(false)

         const handleSetup = async () => {
           const res = await fetch("/api/auth/totp/setup", { method: "POST" })
           const data = await res.json()

           if (data.error) {
             setError(data.error)
             return
           }

           setQrCode(data.qrCode)
           setSecret(data.secret)
         }

         const handleVerify = async () => {
           const res = await fetch("/api/auth/totp/verify", {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify({ code }),
           })

           const data = await res.json()

           if (data.error) {
             setError(data.error)
             return
           }

           setSuccess(true)
           setQrCode(null)
           setSecret(null)
         }

         return (
           <div className="p-8 max-w-2xl mx-auto">
             <h1 className="text-2xl font-bold mb-4">Security Settings</h1>

             {success && (
               <div className="p-4 bg-green-100 text-green-800 rounded mb-4">
                 2FA enabled successfully!
               </div>
             )}

             {error && (
               <div className="p-4 bg-red-100 text-red-800 rounded mb-4">
                 {error}
               </div>
             )}

             {!qrCode ? (
               <button
                 onClick={handleSetup}
                 className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
               >
                 Enable 2FA
               </button>
             ) : (
               <div className="space-y-4">
                 <div>
                   <p className="font-medium mb-2">
                     Scan this QR code with your authenticator app:
                   </p>
                   <img src={qrCode} alt="QR Code" className="border p-4" />
                 </div>

                 <div>
                   <p className="text-sm text-gray-600 mb-2">
                     Or enter this code manually: <code>{secret}</code>
                   </p>
                 </div>

                 <div>
                   <label className="block font-medium mb-2">
                     Enter 6-digit code to verify:
                   </label>
                   <input
                     type="text"
                     value={code}
                     onChange={(e) => setCode(e.target.value)}
                     maxLength={6}
                     className="border rounded px-3 py-2 w-32"
                     placeholder="123456"
                   />
                   <button
                     onClick={handleVerify}
                     className="ml-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                   >
                     Verify
                   </button>
                 </div>
               </div>
             )}
           </div>
         )
       }
       ```

    2. Create src/app/auth/verify-2fa/page.tsx (shown after password login):
       ```tsx
       "use client"

       import { useState } from "react"
       import { useSearchParams, useRouter } from "next/navigation"

       export default function Verify2FAPage() {
         const [code, setCode] = useState("")
         const [error, setError] = useState<string | null>(null)
         const searchParams = useSearchParams()
         const router = useRouter()
         const userId = searchParams.get("userId")

         const handleSubmit = async (e: React.FormEvent) => {
           e.preventDefault()

           const res = await fetch("/api/auth/totp/validate", {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify({ userId, code }),
           })

           const data = await res.json()

           if (data.error) {
             setError(data.error)
             return
           }

           // 2FA verified, complete login
           router.push("/dashboard")
         }

         return (
           <div className="flex min-h-screen items-center justify-center">
             <div className="w-full max-w-md p-8">
               <h2 className="text-2xl font-bold mb-4">Two-Factor Authentication</h2>
               <p className="mb-4 text-gray-600">
                 Enter the 6-digit code from your authenticator app
               </p>

               {error && (
                 <div className="p-3 bg-red-100 text-red-800 rounded mb-4">
                   {error}
                 </div>
               )}

               <form onSubmit={handleSubmit} className="space-y-4">
                 <input
                   type="text"
                   value={code}
                   onChange={(e) => setCode(e.target.value)}
                   maxLength={6}
                   className="w-full border rounded px-3 py-2 text-center text-2xl tracking-widest"
                   placeholder="000000"
                   autoFocus
                 />
                 <button
                   type="submit"
                   className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                 >
                   Verify
                 </button>
               </form>
             </div>
           </div>
         )
       }
       ```

    3. Update auth.ts authorize callback to detect 2FA requirement:
       ```ts
       async authorize(credentials) {
         // ... existing password verification ...

         return {
           id: user.id,
           email: user.email,
           name: user.name,
           requiresMfa: user.totpEnabled, // Signal that 2FA is needed
         }
       }
       ```

    4. Update loginAction in src/app/actions/auth.ts to redirect to 2FA page if needed:
       ```ts
       export async function loginAction(formData: FormData) {
         try {
           const result = await signIn("credentials", {
             email: formData.get("email"),
             password: formData.get("password"),
             redirect: false,
           })

           // Check if 2FA required
           const user = await prisma.user.findUnique({
             where: { email: formData.get("email") as string },
             select: { id: true, totpEnabled: true },
           })

           if (user?.totpEnabled) {
             redirect(`/auth/verify-2fa?userId=${user.id}`)
           }

           redirect("/dashboard")
         } catch (error) {
           if (error instanceof AuthError) {
             return { error: error.cause?.err?.message || "Invalid credentials" }
           }
           throw error
         }
       }
       ```
  </action>
  <verify>
    1. Visit /settings/security, click Enable 2FA
    2. Scan QR code with Google Authenticator app
    3. Enter generated code - should succeed
    4. Log out, log back in - should redirect to /auth/verify-2fa
    5. Enter TOTP code from app - should redirect to dashboard
  </verify>
  <done>
    2FA setup UI displays QR code, users can verify codes, login flow requires TOTP verification for users with 2FA enabled.
  </done>
</task>

</tasks>

<verification>
1. User can enable 2FA from security settings
2. QR code generates and displays correctly
3. TOTP codes verify successfully during setup
4. Login flow redirects to 2FA verification for users with 2FA enabled
5. Invalid codes are rejected
6. Clock skew tolerance (±60 seconds) works correctly
</verification>

<success_criteria>
- speakeasy and qrcode installed and working
- TOTP setup generates secret and QR code
- Users can verify setup with authenticator app
- Login requires 2FA verification for users with totpEnabled=true
- Invalid or expired codes rejected
- TotpSetup records expire after 10 minutes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-05-SUMMARY.md`
</output>
