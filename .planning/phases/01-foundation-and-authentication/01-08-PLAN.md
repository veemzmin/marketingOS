---
phase: 01-foundation-and-authentication
plan: 08
type: execute
wave: 4
depends_on: ["01-02", "01-03", "01-06", "01-07"]
files_modified:
  - src/app/admin/organizations/page.tsx
  - src/app/admin/users/page.tsx
  - src/app/admin/users/invite/page.tsx
  - src/app/actions/admin.ts
  - src/lib/auth/permissions.ts
  - src/app/api/admin/users/invite/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can invite users to organization with assigned roles (AUTH-06)"
    - "System enforces role-based permissions preventing unauthorized actions (AUTH-05)"
    - "Admin can view all users in their organization"
    - "Admin can change user roles (Creator, Reviewer, Admin)"
    - "Role changes are logged to audit trail"
  artifacts:
    - path: "src/lib/auth/permissions.ts"
      provides: "Role-based permission checking utilities"
      exports: ["requireRole", "hasPermission"]
    - path: "src/app/actions/admin.ts"
      provides: "Server actions for user management (invite, role change)"
      exports: ["inviteUserAction", "changeUserRoleAction"]
    - path: "src/app/admin/users/page.tsx"
      provides: "User management UI showing all org members"
      min_lines: 80
  key_links:
    - from: "src/app/admin/users/invite/page.tsx"
      to: "src/app/actions/admin.ts (inviteUserAction)"
      via: "form submission"
      pattern: "inviteUserAction"
    - from: "src/lib/auth/permissions.ts (requireRole)"
      to: "prisma.userOrganization.findFirst"
      via: "role lookup and verification"
      pattern: "findFirst.*role"
---

<objective>
Implement admin user management interface for inviting users, assigning roles, and managing organization memberships with role-based permission enforcement.

Purpose: Enable organization administrators to manage team access, assign appropriate permissions (Creator, Reviewer, Admin), and maintain audit trail of permission changes.
Output: Admin UI for user management, invite flow with role assignment, role change functionality, permission checking utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-06-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-07-SUMMARY.md

# Role definitions
- ADMIN: Manage users, view audit logs, all Creator/Reviewer permissions
- REVIEWER: Review and approve content (future phase)
- CREATOR: Create and edit content (future phase)
- VIEWER: Read-only access to organization data
</context>

<tasks>

<task type="auto">
  <name>Create permission checking utilities</name>
  <files>src/lib/auth/permissions.ts</files>
  <action>
    Create src/lib/auth/permissions.ts with role-based access control helpers:

    ```ts
    import { auth } from "@/auth"
    import { prisma } from "@/lib/db/client"
    import { Role } from "@prisma/client"
    import { redirect } from "next/navigation"

    export async function getCurrentUserRole(
      organizationId: string
    ): Promise<Role | null> {
      const session = await auth()
      if (!session?.user?.id) {
        return null
      }

      const membership = await prisma.userOrganization.findFirst({
        where: {
          userId: session.user.id,
          organizationId,
        },
        select: { role: true },
      })

      return membership?.role || null
    }

    export async function requireRole(
      organizationId: string,
      allowedRoles: Role[]
    ): Promise<void> {
      const role = await getCurrentUserRole(organizationId)

      if (!role || !allowedRoles.includes(role)) {
        redirect("/unauthorized")
      }
    }

    export async function hasPermission(
      organizationId: string,
      requiredRole: Role
    ): Promise<boolean> {
      const role = await getCurrentUserRole(organizationId)
      if (!role) return false

      // Role hierarchy: ADMIN > REVIEWER > CREATOR > VIEWER
      const roleHierarchy: Record<Role, number> = {
        ADMIN: 3,
        REVIEWER: 2,
        CREATOR: 1,
        VIEWER: 0,
      }

      return roleHierarchy[role] >= roleHierarchy[requiredRole]
    }

    export async function requireAdmin(organizationId: string): Promise<void> {
      await requireRole(organizationId, ["ADMIN"])
    }

    export interface UserWithRole {
      userId: string
      role: Role
    }

    export async function getCurrentUserMembership(
      organizationId: string
    ): Promise<UserWithRole | null> {
      const session = await auth()
      if (!session?.user?.id) {
        return null
      }

      const membership = await prisma.userOrganization.findFirst({
        where: {
          userId: session.user.id,
          organizationId,
        },
        select: { userId: true, role: true },
      })

      return membership
    }
    ```

    Why hierarchy: Admin can do everything Reviewer can do, Reviewer can do everything Creator can do, etc.
  </action>
  <verify>
    Test permission helpers with different roles - should correctly allow/deny based on hierarchy.
  </verify>
  <done>
    Permission utilities created with role checking, hierarchy comparison, and redirect-based enforcement.
  </done>
</task>

<task type="auto">
  <name>Build user invitation system</name>
  <files>src/app/actions/admin.ts, src/app/admin/users/invite/page.tsx, src/lib/email/client.ts</files>
  <action>
    1. Create invitation server actions:
       ```ts
       // src/app/actions/admin.ts
       "use server"

       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import { requireAdmin } from "@/lib/auth/permissions"
       import { logRoleChange } from "@/lib/audit/logger"
       import { sendEmail } from "@/lib/email/client"
       import { Role } from "@prisma/client"
       import crypto from "crypto"
       import { redirect } from "next/navigation"

       export async function inviteUserAction(formData: FormData) {
         const session = await auth()
         if (!session?.user?.id) {
           return { error: "Not authenticated" }
         }

         const organizationId = formData.get("organizationId") as string
         const email = formData.get("email") as string
         const role = formData.get("role") as Role
         const name = formData.get("name") as string

         // Verify admin permission
         await requireAdmin(organizationId)

         // Check if user already exists
         let user = await prisma.user.findUnique({ where: { email } })

         if (user) {
           // Check if already member
           const existing = await prisma.userOrganization.findFirst({
             where: {
               userId: user.id,
               organizationId,
             },
           })

           if (existing) {
             return { error: "User already member of this organization" }
           }

           // Add existing user to organization
           await prisma.userOrganization.create({
             data: {
               userId: user.id,
               organizationId,
               role,
             },
           })

           // Log role grant
           await logRoleChange({
             organizationId,
             userId: session.user.id,
             userEmail: session.user.email || "",
             targetUserId: user.id,
             oldRole: null,
             newRole: role,
           })

           // Send notification email
           await sendEmail({
             to: email,
             subject: "Added to Marketing OS organization",
             html: `
               <p>Hi ${name || "there"},</p>
               <p>You've been added to an organization on Marketing OS with the role: ${role}.</p>
               <p><a href="${process.env.NEXTAUTH_URL}/auth/login">Log in to get started</a></p>
             `,
           })

           return { success: true, message: "User added to organization" }
         }

         // Create new user (unverified, will verify on first login)
         const tempPassword = crypto.randomBytes(16).toString("hex")
         const { hashPassword } = await import("@/lib/auth/password")
         const passwordHash = await hashPassword(tempPassword)

         user = await prisma.user.create({
           data: {
             email,
             name,
             passwordHash,
             emailVerified: null, // Will verify via email link
           },
         })

         // Add to organization
         await prisma.userOrganization.create({
           data: {
             userId: user.id,
             organizationId,
             role,
           },
         })

         // Generate verification token
         const token = crypto.randomUUID()
         const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days for invites

         await prisma.emailVerificationToken.create({
           data: {
             userId: user.id,
             token,
             expiresAt,
           },
         })

         // Log role grant
         await logRoleChange({
           organizationId,
           userId: session.user.id,
           userEmail: session.user.email || "",
           targetUserId: user.id,
           oldRole: null,
           newRole: role,
         })

         // Send invite email with setup link
         const setupUrl = `${process.env.NEXTAUTH_URL}/auth/setup-account?token=${token}`
         await sendEmail({
           to: email,
           subject: "You've been invited to Marketing OS",
           html: `
             <p>Hi ${name || "there"},</p>
             <p>You've been invited to join Marketing OS with the role: ${role}.</p>
             <p><a href="${setupUrl}">Click here to set your password and get started</a></p>
             <p>This link expires in 7 days.</p>
           `,
         })

         return { success: true, message: "Invitation sent" }
       }

       export async function changeUserRoleAction(formData: FormData) {
         const session = await auth()
         if (!session?.user?.id) {
           return { error: "Not authenticated" }
         }

         const organizationId = formData.get("organizationId") as string
         const targetUserId = formData.get("userId") as string
         const newRole = formData.get("role") as Role

         // Verify admin permission
         await requireAdmin(organizationId)

         // Get current membership
         const membership = await prisma.userOrganization.findFirst({
           where: {
             userId: targetUserId,
             organizationId,
           },
         })

         if (!membership) {
           return { error: "User not member of organization" }
         }

         const oldRole = membership.role

         // Update role
         await prisma.userOrganization.update({
           where: { id: membership.id },
           data: { role: newRole },
         })

         // Log role change
         const targetUser = await prisma.user.findUnique({
           where: { id: targetUserId },
           select: { email: true },
         })

         await logRoleChange({
           organizationId,
           userId: session.user.id,
           userEmail: session.user.email || "",
           targetUserId,
           oldRole,
           newRole,
         })

         return { success: true, message: "Role updated" }
       }
       ```

    2. Create invite UI page:
       ```tsx
       // src/app/admin/users/invite/page.tsx
       import { auth } from "@/auth"
       import { requireAdmin } from "@/lib/auth/permissions"
       import { inviteUserAction } from "@/app/actions/admin"
       import { redirect } from "next/navigation"
       import { headers } from "next/headers"

       export default async function InviteUserPage() {
         const session = await auth()
         if (!session) {
           redirect("/auth/login")
         }

         const headersList = headers()
         const organizationId = headersList.get("x-tenant-id")

         if (!organizationId) {
           redirect("/")
         }

         await requireAdmin(organizationId)

         return (
           <div className="p-8 max-w-2xl mx-auto">
             <h1 className="text-2xl font-bold mb-6">Invite User</h1>

             <form action={inviteUserAction} className="space-y-6">
               <input type="hidden" name="organizationId" value={organizationId} />

               <div>
                 <label htmlFor="email" className="block text-sm font-medium mb-2">
                   Email Address
                 </label>
                 <input
                   id="email"
                   name="email"
                   type="email"
                   required
                   className="w-full border rounded px-3 py-2"
                 />
               </div>

               <div>
                 <label htmlFor="name" className="block text-sm font-medium mb-2">
                   Full Name
                 </label>
                 <input
                   id="name"
                   name="name"
                   type="text"
                   required
                   className="w-full border rounded px-3 py-2"
                 />
               </div>

               <div>
                 <label htmlFor="role" className="block text-sm font-medium mb-2">
                   Role
                 </label>
                 <select
                   id="role"
                   name="role"
                   required
                   className="w-full border rounded px-3 py-2"
                 >
                   <option value="CREATOR">Creator - Can create content</option>
                   <option value="REVIEWER">Reviewer - Can review content</option>
                   <option value="ADMIN">Admin - Full access</option>
                   <option value="VIEWER">Viewer - Read-only</option>
                 </select>
               </div>

               <div className="flex gap-4">
                 <button
                   type="submit"
                   className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                 >
                   Send Invitation
                 </button>
                 <a
                   href="/admin/users"
                   className="px-4 py-2 border rounded hover:bg-gray-50"
                 >
                   Cancel
                 </a>
               </div>
             </form>
           </div>
         )
       }
       ```
  </action>
  <verify>
    1. Log in as admin user
    2. Visit /admin/users/invite
    3. Enter email, name, role - submit form
    4. Check database - UserOrganization record created
    5. Check audit logs - role_grant event logged
    6. Check email (console or provider) - invitation sent
  </verify>
  <done>
    User invitation system allows admins to invite new users or add existing users to organization, assigns role, sends email, logs to audit trail.
  </done>
</task>

<task type="auto">
  <name>Build user management UI</name>
  <files>src/app/admin/users/page.tsx, src/app/admin/organizations/page.tsx</files>
  <action>
    1. Create user management page:
       ```tsx
       // src/app/admin/users/page.tsx
       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import { requireAdmin } from "@/lib/auth/permissions"
       import { redirect } from "next/navigation"
       import { headers } from "next/headers"
       import { changeUserRoleAction } from "@/app/actions/admin"

       export default async function UsersPage() {
         const session = await auth()
         if (!session) {
           redirect("/auth/login")
         }

         const headersList = headers()
         const organizationId = headersList.get("x-tenant-id")

         if (!organizationId) {
           redirect("/")
         }

         await requireAdmin(organizationId)

         // Fetch all users in organization
         const members = await prisma.userOrganization.findMany({
           where: { organizationId },
           include: {
             user: {
               select: {
                 id: true,
                 email: true,
                 name: true,
                 emailVerified: true,
                 totpEnabled: true,
                 createdAt: true,
               },
             },
           },
           orderBy: { createdAt: "desc" },
         })

         return (
           <div className="p-8">
             <div className="flex justify-between items-center mb-6">
               <h1 className="text-2xl font-bold">Users</h1>
               <a
                 href="/admin/users/invite"
                 className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
               >
                 Invite User
               </a>
             </div>

             <div className="bg-white rounded-lg shadow overflow-hidden">
               <table className="min-w-full divide-y divide-gray-200">
                 <thead className="bg-gray-50">
                   <tr>
                     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                       User
                     </th>
                     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                       Role
                     </th>
                     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                       Status
                     </th>
                     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                       2FA
                     </th>
                     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                       Actions
                     </th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-200">
                   {members.map((member) => (
                     <tr key={member.id}>
                       <td className="px-6 py-4">
                         <div>
                           <div className="font-medium">{member.user.name}</div>
                           <div className="text-sm text-gray-500">{member.user.email}</div>
                         </div>
                       </td>
                       <td className="px-6 py-4">
                         <form action={changeUserRoleAction}>
                           <input type="hidden" name="organizationId" value={organizationId} />
                           <input type="hidden" name="userId" value={member.user.id} />
                           <select
                             name="role"
                             defaultValue={member.role}
                             onChange={(e) => e.currentTarget.form?.requestSubmit()}
                             className="border rounded px-2 py-1 text-sm"
                           >
                             <option value="ADMIN">Admin</option>
                             <option value="REVIEWER">Reviewer</option>
                             <option value="CREATOR">Creator</option>
                             <option value="VIEWER">Viewer</option>
                           </select>
                         </form>
                       </td>
                       <td className="px-6 py-4 text-sm">
                         {member.user.emailVerified ? (
                           <span className="px-2 py-1 bg-green-100 text-green-800 rounded">
                             Verified
                           </span>
                         ) : (
                           <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">
                             Pending
                           </span>
                         )}
                       </td>
                       <td className="px-6 py-4 text-sm">
                         {member.user.totpEnabled ? (
                           <span className="text-green-600">Enabled</span>
                         ) : (
                           <span className="text-gray-400">Disabled</span>
                         )}
                       </td>
                       <td className="px-6 py-4 text-sm">
                         <button className="text-red-600 hover:underline">
                           Remove
                         </button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>

               {members.length === 0 && (
                 <p className="text-center text-gray-500 py-8">No users yet</p>
               )}
             </div>
           </div>
         )
       }
       ```

    2. Create organization overview page:
       ```tsx
       // src/app/admin/organizations/page.tsx
       import { auth } from "@/auth"
       import { prisma } from "@/lib/db/client"
       import { redirect } from "next/navigation"
       import { headers } from "next/headers"

       export default async function OrganizationsPage() {
         const session = await auth()
         if (!session) {
           redirect("/auth/login")
         }

         const headersList = headers()
         const organizationId = headersList.get("x-tenant-id")

         if (!organizationId) {
           redirect("/")
         }

         const org = await prisma.organization.findUnique({
           where: { id: organizationId },
           include: {
             members: {
               include: { user: true },
             },
           },
         })

         if (!org) {
           redirect("/")
         }

         return (
           <div className="p-8">
             <h1 className="text-2xl font-bold mb-6">Organization</h1>

             <div className="bg-white rounded-lg shadow p-6 space-y-4">
               <div>
                 <label className="text-sm font-medium text-gray-500">Name</label>
                 <p className="text-lg">{org.name}</p>
               </div>

               <div>
                 <label className="text-sm font-medium text-gray-500">Slug</label>
                 <p className="text-lg font-mono">{org.slug}</p>
               </div>

               <div>
                 <label className="text-sm font-medium text-gray-500">Members</label>
                 <p className="text-lg">{org.members.length} users</p>
               </div>

               <div>
                 <label className="text-sm font-medium text-gray-500">Created</label>
                 <p className="text-lg">{new Date(org.createdAt).toLocaleDateString()}</p>
               </div>
             </div>
           </div>
         )
       }
       ```
  </action>
  <verify>
    1. Visit /admin/users - should see list of organization members
    2. Change user's role via dropdown - should update immediately
    3. Check audit log - should see role_change event
    4. Visit /admin/organizations - should see org details
  </verify>
  <done>
    User management UI displays all organization members, allows role changes, shows verification/2FA status, and provides invite link.
  </done>
</task>

</tasks>

<verification>
1. Admin can view all users in organization
2. Admin can invite new users via email with role assignment
3. Admin can change existing user roles
4. Permission checking prevents non-admins from accessing admin features
5. Role changes logged to audit trail
6. Invitation emails sent with setup links
7. Role hierarchy enforced (Admin > Reviewer > Creator > Viewer)
</verification>

<success_criteria>
- Permission utilities enforce role-based access control
- Admin can invite users with email, name, and role
- Existing users can be added to organization
- New users receive invite email with account setup link
- Admin can change user roles via dropdown
- All role changes logged to audit trail
- User management UI shows verification and 2FA status
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-08-SUMMARY.md`
</output>
